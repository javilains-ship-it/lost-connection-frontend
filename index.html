<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Siiy√∫</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- Babel para JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Socket.io Client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="places-search.js"></script>
  <script src="security-manager.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
    }
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #9333ea;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: .5; }
    }
    /* Estilos para badges de tipo */
    .badge-alerta {
      background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
    }
    .badge-ubicacion {
      background: linear-gradient(135deg, #3b82f6 0%, #10b981 100%);
    }
    /* Animaciones del tutorial */
    .slide-in-right {
      animation: slideInRight 0.4s ease-out;
    }
    .slide-in-left {
      animation: slideInLeft 0.4s ease-out;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-50px); }
      to { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body class="bg-gray-100">

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============================================
    // CONFIGURACI√ìN - CAMBIAR ESTAS URLs
    // ============================================
    const API_URL = 'https://lost-connection-backend.onrender.com/api';
    const SOCKET_URL = 'https://lost-connection-backend.onrender.com';

    // Configuraci√≥n de geolocalizaci√≥n
    const GEO_CONFIG = {
      enableHighAccuracy: true,
      timeout: 30000, // 30 segundos (aumentado desde 10)
      maximumAge: 300000, // 5 minutos
      distanceFilter: 50, // Guardar solo si se movi√≥ m√°s de 50 metros
      trackingInterval: 300000 // Guardar ubicaci√≥n cada 5 minutos
    };

    // ============================================
    // SERVICIO API
    // ============================================
    const api = {
      token: localStorage.getItem('lc_token'),
      
      setToken(token) {
        this.token = token;
        if (token) {
          localStorage.setItem('lc_token', token);
        } else {
          localStorage.removeItem('lc_token');
        }
      },
      
      async request(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          ...options.headers
        };
        
        if (this.token) {
          headers['Authorization'] = `Bearer ${this.token}`;
        }
        
        try {
          const response = await fetch(`${API_URL}${endpoint}`, {
            ...options,
            headers
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Error en la petici√≥n');
          }
          
          return data;
        } catch (error) {
          console.error('API Error:', error);
          throw error;
        }
      },
      
      // Auth
      async login(nickname, password = null) {
        const body = { nickname };
        if (password) body.password = password;
        return this.request('/auth/login', {
          method: 'POST',
          body: JSON.stringify(body)
        });
      },
      
      async getMe() {
        return this.request('/auth/me');
      },
      
      // Alerts
      async getAlerts(page = 1) {
        return this.request(`/alerts?page=${page}`);
      },
      
      async createAlert(data) {
        return this.request('/alerts', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },
      
      // Locations
      async getLocations() {
        return this.request('/locations');
      },
      
      async addLocation(data) {
        return this.request('/locations', {
          method: 'POST',
          body: JSON.stringify(data)
        });
      },
      
      async addLocationsBatch(locations) {
        return this.request('/locations/batch', {
          method: 'POST',
          body: JSON.stringify({ locations })
        });
      },
      
      async deleteLocation(id) {
        return this.request(`/locations/${id}`, { method: 'DELETE' });
      },
      
      // Matches
      async getMatches() {
        return this.request('/matches');
      },
      
      async createMatch(alertId) {
        return this.request('/matches', {
          method: 'POST',
          body: JSON.stringify({ alertId })
        });
      },
      
      async getMatch(id) {
        return this.request(`/matches/${id}`);
      },
      
      async sendMessage(matchId, content) {
        return this.request(`/matches/${matchId}/messages`, {
          method: 'POST',
          body: JSON.stringify({ content })
        });
      },
      
      async revealIdentity(matchId) {
        return this.request(`/matches/${matchId}/reveal`, { method: 'PUT' });
      }
    };

    // ============================================
    // SERVICIO DE GEOLOCALIZACI√ìN
    // ============================================
    const useGeolocation = () => {
      const [position, setPosition] = useState(null);
      const [error, setError] = useState(null);
      const [tracking, setTracking] = useState(false);
      const watchIdRef = useRef(null);
      const lastPositionRef = useRef(null);
      const locationQueueRef = useRef([]);

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                  Math.cos(œÜ1) * Math.cos(œÜ2) *
                  Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      };

      const shouldSaveLocation = (newPos) => {
        if (!lastPositionRef.current) return true;
        
        const distance = calculateDistance(
          lastPositionRef.current.lat,
          lastPositionRef.current.lng,
          newPos.lat,
          newPos.lng
        );
        
        return distance >= GEO_CONFIG.distanceFilter;
      };

      const saveLocationToQueue = (coords) => {
        const location = {
          lat: coords.latitude,
          lng: coords.longitude,
          timestamp: new Date().toISOString(),
          place: 'Ubicaci√≥n autom√°tica',
          accuracy: coords.accuracy
        };

        if (shouldSaveLocation(location)) {
          locationQueueRef.current.push(location);
          lastPositionRef.current = location;
          setPosition(location);
          
          console.log('üìç Nueva ubicaci√≥n guardada:', location);
        }
      };

      const flushLocationQueue = async () => {
        if (locationQueueRef.current.length === 0) return;
        
        try {
          const locationsToSave = [...locationQueueRef.current];
          locationQueueRef.current = [];
          
          await api.addLocationsBatch(locationsToSave);
          console.log(`‚úÖ ${locationsToSave.length} ubicaciones guardadas en el servidor`);
        } catch (error) {
          console.error('Error guardando ubicaciones:', error);
          locationQueueRef.current = [...locationQueueRef.current, ...locationsToSave];
        }
      };

      const startTracking = () => {
        if (!navigator.geolocation) {
          setError('Geolocalizaci√≥n no soportada');
          return;
        }

        console.log('üöÄ Iniciando tracking GPS...');
        
        const attemptGPS = () => {
          watchIdRef.current = navigator.geolocation.watchPosition(
            (pos) => {
              saveLocationToQueue(pos.coords);
              setError(null);
            },
            (err) => {
              console.error('Error GPS:', err);
              
              // Si falla con alta precisi√≥n, intentar con baja precisi√≥n
              if (err.code === 3 && GEO_CONFIG.enableHighAccuracy) { // TIMEOUT
                console.log('‚ö†Ô∏è Timeout con alta precisi√≥n, intentando baja precisi√≥n...');
                
                navigator.geolocation.watchPosition(
                  (pos) => {
                    saveLocationToQueue(pos.coords);
                    setError(null);
                  },
                  (err2) => {
                    console.error('Error GPS (baja precisi√≥n):', err2);
                    setError(err2.message + ' - Reintentando en 60s...');
                  },
                  { ...GEO_CONFIG, enableHighAccuracy: false }
                );
              } else {
                setError(err.message + ' - Reintentando en 60s...');
              }
            },
            GEO_CONFIG
          );
        };
        
        // Intentar inicialmente
        attemptGPS();
        
        // Reintentar cada 60 segundos si hay error
        const retryInterval = setInterval(() => {
          if (error) {
            console.log('üîÑ Reintentando GPS...');
            attemptGPS();
          }
        }, 60000); // 60 segundos

        const flushInterval = setInterval(flushLocationQueue, GEO_CONFIG.trackingInterval);

        setTracking(true);

        return () => {
          if (watchIdRef.current) {
            navigator.geolocation.clearWatch(watchIdRef.current);
          }
          clearInterval(flushInterval);
          clearInterval(retryInterval);
          flushLocationQueue();
        };
      };

      const stopTracking = () => {
        if (watchIdRef.current) {
          navigator.geolocation.clearWatch(watchIdRef.current);
          watchIdRef.current = null;
        }
        flushLocationQueue();
        setTracking(false);
        console.log('‚èπÔ∏è Tracking GPS detenido');
      };

      const requestPermission = async () => {
        try {
          const result = await navigator.permissions.query({ name: 'geolocation' });
          return result.state === 'granted' || result.state === 'prompt';
        } catch {
          return true;
        }
      };

      return {
        currentPosition: position,
        position,
        error,
        tracking,
        startTracking,
        stopTracking,
        requestPermission,
        queuedLocations: locationQueueRef.current.length
      };
    };

    // ============================================
    // ICONOS SVG
    // ============================================
    const MapPin = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    );

    const Bell = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
      </svg>
    );

    const Clock = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );

    const MessageCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
    );

    const Send = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    );

    const Eye = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
      </svg>
    );

    const Navigation = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
      </svg>
    );

    const Plus = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
      </svg>
    );

    const X = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    );

    const Trash = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    );

    const LogOut = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
      </svg>
    );

    const Loader = ({ className }) => (
      <svg className={`animate-spin ${className}`} fill="none" viewBox="0 0 24 24">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    );

    // ============================================
    // COMPONENTE PRINCIPAL
    // ============================================
    const App = () => {
      // Estado de autenticaci√≥n
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      
      // Estado de la app
      const [view, setView] = useState('feed');
      const [alerts, setAlerts] = useState([]);
      const [matches, setMatches] = useState([]);
      const [locations, setLocations] = useState([]);
      const [activeChat, setActiveChat] = useState(null);
      const [chatMessages, setChatMessages] = useState([]);
      const [notification, setNotification] = useState(null);
      
      // Estado de formularios
      const [tempNickname, setTempNickname] = useState('');
      const [tempPassword, setTempPassword] = useState('');
      const [newMessage, setNewMessage] = useState('');
      const [showAddLocation, setShowAddLocation] = useState(false);
      const [isTyping, setIsTyping] = useState(false);
      const [sendingAlert, setSendingAlert] = useState(false);
      const [otherUserTyping, setOtherUserTyping] = useState(false);
      
      const [newAlert, setNewAlert] = useState({
        place: '',
        date: '',
        time: '',
        description: ''
      });

      const [manualLocation, setManualLocation] = useState({
        place: '',
        date: '',
        time: ''
      });

      const [placeSuggestions, setPlaceSuggestions] = useState([]);
      const [alertPlaceSuggestions, setAlertPlaceSuggestions] = useState([]);

      // Tutorial
      const [showTutorial, setShowTutorial] = useState(false);
      const [tutorialStep, setTutorialStep] = useState(0);
      
      // Men√∫ de nueva alerta
      const [showAlertMenu, setShowAlertMenu] = useState(false);
      
      // Notificaciones en tiempo real
      const [realtimeNotification, setRealtimeNotification] = useState(null);
      const [unreadAlertsCount, setUnreadAlertsCount] = useState(0);

      // Geolocalizaci√≥n
      const geo = useGeolocation();

      // WebSocket
      const socketRef = useRef(null);
      const typingTimeoutRef = useRef(null);

      // Mostrar notificaci√≥n
      const showNotification = (message, type = 'success') => {
        setNotification({ message, type });
        setTimeout(() => setNotification(null), 3000);
      };

      // Verificar sesi√≥n al cargar
      useEffect(() => {
        const checkAuth = async () => {
          if (api.token) {
            try {
              const { data } = await api.getMe();
              setUser(data.user);
              setIsAuthenticated(true);
              await loadData();
            } catch (error) {
              api.setToken(null);
            }
          }
          setLoading(false);
        };
        checkAuth();
      }, []);

      // Iniciar tracking GPS cuando el usuario est√° autenticado
      useEffect(() => {
        if (isAuthenticated) {
          const cleanup = geo.startTracking();
          return cleanup;
        }
      }, [isAuthenticated]);

      // Conectar WebSocket
      useEffect(() => {
        if (isAuthenticated && api.token) {
          const socket = io(SOCKET_URL, {
            auth: { token: api.token }
          });

          socket.on('connect', () => {
            console.log('WebSocket conectado');
          });

          socket.on('new-message', (message) => {
            setChatMessages(prev => [...prev, message]);
          });

          socket.on('user-typing', () => {
            setOtherUserTyping(true);
          });

          socket.on('user-stop-typing', () => {
            setOtherUserTyping(false);
          });

          socket.on('identity-revealed', ({ userId, nickname }) => {
            setChatMessages(prev => prev.map(msg => 
              msg.sender_id === userId ? { ...msg, is_revealed: true, sender_nickname: nickname } : msg
            ));
          });

          // Notificaciones en tiempo real
          socket.on('new-alert', (alert) => {
            console.log('üì¢ Nueva alerta recibida:', alert);
            setAlerts(prev => [alert, ...prev]);
            setUnreadAlertsCount(prev => prev + 1);
            setRealtimeNotification({
              type: 'alert',
              title: 'üîî Nueva Alerta',
              message: `Alguien te busca en ${alert.place_name}`,
              data: alert
            });
            setTimeout(() => setRealtimeNotification(null), 5000);
          });

          socket.on('new-match', (match) => {
            console.log('üí¨ Nuevo match recibido:', match);
            setMatches(prev => [match, ...prev]);
            setRealtimeNotification({
              type: 'match',
              title: 'üíú ¬°Nuevo Match!',
              message: `Alguien respondi√≥ a tu alerta en ${match.place_name}`,
              data: match
            });
            setTimeout(() => setRealtimeNotification(null), 5000);
          });

          socketRef.current = socket;

          return () => {
            socket.disconnect();
          };
        }
      }, [isAuthenticated]);

      // Cerrar men√∫ de alerta al hacer click fuera
      useEffect(() => {
        const handleClickOutside = (event) => {
          if (showAlertMenu && !event.target.closest('.relative')) {
            setShowAlertMenu(false);
          }
        };
        
        document.addEventListener('click', handleClickOutside);
        return () => document.removeEventListener('click', handleClickOutside);
      }, [showAlertMenu]);

      // Auto-recargar alertas cada 30 segundos (polling)
      useEffect(() => {
        if (!isAuthenticated) return;
        
        const interval = setInterval(async () => {
          try {
            const alertsRes = await api.getAlerts();
            setAlerts(alertsRes.data.alerts);
            console.log('üîÑ Alertas actualizadas autom√°ticamente');
          } catch (error) {
            console.error('Error auto-recargando alertas:', error);
          }
        }, 30000); // 30 segundos
        
        return () => clearInterval(interval);
      }, [isAuthenticated]);

      // Cargar datos
      const loadData = async () => {
        try {
          const [alertsRes, matchesRes, locationsRes] = await Promise.all([
            api.getAlerts(),
            api.getMatches(),
            api.getLocations()
          ]);
          
          setAlerts(alertsRes.data.alerts);
          setMatches(matchesRes.data.matches);
          setLocations(locationsRes.data.locations);
        } catch (error) {
          console.error('Error cargando datos:', error);
        }
      };

      // Login
      const handleLogin = async () => {
        if (!tempNickname.trim()) return;
        
        setLoading(true);
        try {
          const { data } = await api.login(tempNickname.trim(), tempPassword || null);
          api.setToken(data.token);
          setUser(data.user);
          setIsAuthenticated(true);
          
          if (window.SecurityManager && tempPassword) {
            window.SecurityManager.password.setHasPassword(true);
          }
          
          await loadData();
          
          // Mostrar tutorial si es nuevo usuario y no lo ha visto
          const hasSeenTutorial = localStorage.getItem('lc_tutorial_seen');
          if (data.isNewUser && !hasSeenTutorial) {
            setShowTutorial(true);
            setTutorialStep(0);
          }
          
          showNotification(data.isNewUser ? '¬°Bienvenido!' : 'Sesi√≥n iniciada');
          setTempPassword('');
        } catch (error) {
          showNotification(error.message, 'error');
        }
        setLoading(false);
      };

      // Logout
      const handleLogout = () => {
        geo.stopTracking();
        api.setToken(null);
        setIsAuthenticated(false);
        setUser(null);
        setAlerts([]);
        setMatches([]);
        setLocations([]);
        if (socketRef.current) {
          socketRef.current.disconnect();
        }
      };

      // A√±adir ubicaci√≥n manual
      const addManualLocation = async () => {
        if (!manualLocation.place || !manualLocation.date || !manualLocation.time) return;
        
        try {
          const { data } = await api.addLocation(manualLocation);
          setLocations([data.location, ...locations]);
          setManualLocation({ place: '', date: '', time: '' });
          setShowAddLocation(false);
          showNotification('Ubicaci√≥n a√±adida');
          
          const alertsRes = await api.getAlerts();
          setAlerts(alertsRes.data.alerts);
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Eliminar ubicaci√≥n
      const removeLocation = async (id) => {
        try {
          await api.deleteLocation(id);
          setLocations(locations.filter(loc => loc.id !== id));
          showNotification('Ubicaci√≥n eliminada');
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Crear alerta
      const createAlert = async () => {
        if (!newAlert.place || !newAlert.date || !newAlert.time || !newAlert.description) return;
        
        try {
          const alertData = { ...newAlert };
          
          if (geo.position && geo.position.lat && geo.position.lng) {
            alertData.latitude = geo.position.lat;
            alertData.longitude = geo.position.lng;
            console.log('üìç Enviando alerta con GPS:', alertData.latitude, alertData.longitude);
          } else {
            console.log('üìç Enviando alerta sin GPS (se usar√° geocoding)');
          }
          
          const { data } = await api.createAlert(alertData);
          
          // Recargar todas las alertas desde el servidor
          const alertsRes = await api.getAlerts();
          setAlerts(alertsRes.data.alerts);
          
          setNewAlert({ place: '', date: '', time: '', description: '' });
          setView('feed');
          
          const gpsMessage = data.usedGPS ? ' (con GPS)' : '';
          showNotification(`¬°Alerta publicada${gpsMessage}! ${data.notifiedUsers} usuarios notificados`);
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Responder a alerta
      const respondToAlert = async (alertId) => {
        try {
          await api.createMatch(alertId);
          const matchesRes = await api.getMatches();
          setMatches(matchesRes.data.matches);
          showNotification('¬°Match creado!');
          
          setAlerts(alerts.map(a => 
            a.id === alertId ? { ...a, has_responded: true } : a
          ));
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Abrir chat
      const openChat = async (matchId) => {
        try {
          const { data } = await api.getMatch(matchId);
          setChatMessages(data.messages);
          setActiveChat(data.match);
          setView('chat');
          
          if (socketRef.current) {
            socketRef.current.emit('join-match', matchId);
          }
          
          setMatches(prev => prev.map(m => 
            m.id === matchId ? { ...m, hasUnread: false } : m
          ));
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Cerrar chat
      const closeChat = () => {
        if (socketRef.current && activeChat) {
          socketRef.current.emit('leave-match', activeChat.id);
        }
        setActiveChat(null);
        setChatMessages([]);
        setView('feed');
      };

      // Enviar mensaje
      const sendMessage = async () => {
        if (!newMessage.trim() || !activeChat) return;
        
        try {
          if (socketRef.current) {
            socketRef.current.emit('send-message', {
              matchId: activeChat.id,
              content: newMessage.trim()
            });
          }
          
          setNewMessage('');
          
          if (socketRef.current) {
            socketRef.current.emit('stop-typing', activeChat.id);
          }
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // Manejar escritura
      const handleTyping = (e) => {
        setNewMessage(e.target.value);
        
        if (socketRef.current && activeChat) {
          if (!isTyping) {
            setIsTyping(true);
            socketRef.current.emit('typing', activeChat.id);
          }
          
          if (typingTimeoutRef.current) {
            clearTimeout(typingTimeoutRef.current);
          }
          
          typingTimeoutRef.current = setTimeout(() => {
            setIsTyping(false);
            socketRef.current.emit('stop-typing', activeChat.id);
          }, 2000);
        }
      };

      // Revelar identidad
      const revealIdentity = async () => {
        if (!activeChat) return;
        
        try {
          if (socketRef.current) {
            socketRef.current.emit('reveal-identity', activeChat.id);
          }
          showNotification('Tu identidad ha sido revelada');
        } catch (error) {
          showNotification(error.message, 'error');
        }
      };

      // ============================================
      // VISTAS
      // ============================================

      // Loading inicial
      if (loading && !isAuthenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
            <Loader className="w-12 h-12 text-white" />
          </div>
        );
      }

      // Login
      if (!isAuthenticated) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full fade-in">
              <div className="text-center mb-8">
                <div className="inline-block p-4 bg-purple-100 rounded-full mb-4">
                  <MapPin className="w-10 h-10 text-purple-600" />
                </div>
                <h1 className="text-3xl font-bold text-gray-800 mb-2">Siiy√∫</h1>
                <p className="text-gray-600">Reconecta con encuentros perdidos</p>
              </div>
              
              <div className="space-y-4">
                <input
                  type="text"
                  placeholder="Elige un nickname"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                  value={tempNickname}
                  onChange={(e) => setTempNickname(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                  disabled={loading}
                />
                <div className="relative">
                  <input
                    type="password"
                    placeholder="Contrase√±a (opcional)"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                    value={tempPassword}
                    onChange={(e) => setTempPassword(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                    disabled={loading}
                  />
                  <p className="mt-1 text-xs text-gray-500">
                    üí° Puedes dejarla vac√≠a ahora y a√±adirla despu√©s
                  </p>
                </div>
                <button
                  onClick={handleLogin}
                  disabled={!tempNickname.trim() || loading}
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {loading ? <Loader className="w-5 h-5" /> : null}
                  Entrar
                </button>
              </div>
              
              <div className="mt-6 pt-6 border-t border-gray-200">
                <p className="text-xs text-gray-500 text-center">
                  Al entrar, se activar√° el tracking GPS autom√°tico para mejorar tu experiencia.
                </p>
              </div>
            </div>
          </div>
        );
      }

      // Tutorial
      if (showTutorial && isAuthenticated) {
        const tutorialContent = [
          // Pantalla 1: Bienvenida + Prop√≥sito
          {
            emoji: 'üéâ',
            title: '¬°Bienvenido a Siiy√∫!',
            content: (
              <div className="space-y-4">
                <div className="p-4 bg-pink-50 rounded-lg border-l-4 border-pink-500">
                  <p className="text-gray-700 text-center font-semibold text-lg mb-2">
                    ¬øViste a alguien con quien quieres hablar pero no pudiste?
                  </p>
                </div>
                
                <p className="text-lg text-gray-700 leading-relaxed text-center">
                  Siiy√∫ te ayuda a <span className="font-semibold text-purple-600">conectaros</span> de una forma <span className="font-semibold text-purple-600">discreta y an√≥nima</span>.
                </p>
                
                <div className="mt-6 space-y-3">
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-6 h-6 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                    <p className="text-gray-700 flex-1">Publica una <span className="font-semibold">alerta</span> describiendo a la persona y d√≥nde/cu√°ndo la viste</p>
                  </div>
                  
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-6 h-6 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                    <p className="text-gray-700 flex-1">Si esa persona estaba ah√≠, <span className="font-semibold">recibir√° tu alerta</span></p>
                  </div>
                  
                  <div className="flex items-start gap-3">
                    <div className="flex-shrink-0 w-6 h-6 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
                    <p className="text-gray-700 flex-1">Si responde "¬°Soy yo!" ‚Üí <span className="font-semibold">Match y chat an√≥nimo üí¨</span></p>
                  </div>
                </div>
              </div>
            )
          },
          // Pantalla 2: Privacidad
          {
            emoji: 'üîí',
            title: 'Tu privacidad importa',
            content: (
              <div className="space-y-3">
                <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                  <p className="text-gray-700">‚úÖ <span className="font-semibold">Chat an√≥nimo</span> al inicio</p>
                </div>
                
                <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                  <p className="text-gray-700">‚úÖ <span className="font-semibold">T√∫ decides</span> cu√°ndo revelar tu identidad</p>
                </div>
                
                <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                  <p className="text-gray-700">‚úÖ GPS solo para matching, <span className="font-semibold">no compartido p√∫blicamente</span></p>
                </div>
                
                <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                  <p className="text-gray-700">‚úÖ Puedes <span className="font-semibold">borrar tus ubicaciones</span> cuando quieras</p>
                </div>
              </div>
            )
          },
          // Pantalla 3: C√≥mo funciona
          {
            emoji: 'üì±',
            title: '¬øC√≥mo funciona?',
            content: (
              <div className="space-y-4">
                <div className="flex gap-4 items-start p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <div className="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">1</div>
                  <div>
                    <h4 className="font-semibold text-gray-800 mb-1">üìç UBICACIONES</h4>
                    <p className="text-sm text-gray-600">Registra d√≥nde estuviste (GPS autom√°tico o manual)</p>
                  </div>
                </div>
                
                <div className="flex gap-4 items-start p-4 bg-pink-50 rounded-lg border-l-4 border-pink-500">
                  <div className="flex-shrink-0 w-8 h-8 bg-pink-500 text-white rounded-full flex items-center justify-center font-bold">2</div>
                  <div>
                    <h4 className="font-semibold text-gray-800 mb-1">üîî ALERTAS</h4>
                    <p className="text-sm text-gray-600">Publica cuando buscas a alguien: "Vi a alguien interesante en [lugar] el [d√≠a]"</p>
                  </div>
                </div>
                
                <div className="flex gap-4 items-start p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                  <div className="flex-shrink-0 w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center font-bold">3</div>
                  <div>
                    <h4 className="font-semibold text-gray-800 mb-1">üí¨ MATCHES</h4>
                    <p className="text-sm text-gray-600">Si alguien estuvo en ese lugar/hora, recibir√° tu alerta y podr√° responder</p>
                  </div>
                </div>
              </div>
            )
          },
          // Pantalla 3: GPS Autom√°tico
          {
            emoji: 'üó∫Ô∏è',
            title: 'GPS Autom√°tico',
            content: (
              <div className="space-y-4">
                <div className="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                  <p className="text-gray-700 mb-2">
                    ‚úÖ <span className="font-semibold">Activamos el GPS</span> para registrar tus ubicaciones autom√°ticamente cada 5 minutos (solo si te mueves)
                  </p>
                </div>
                
                <div className="p-4 bg-blue-50 rounded-lg">
                  <h4 className="font-semibold text-gray-800 mb-2">üì± ¬øPor qu√©?</h4>
                  <p className="text-sm text-gray-600">
                    As√≠ recibes alertas de lugares donde estuviste sin tener que recordar y a√±adirlos manualmente
                  </p>
                </div>
                
                <div className="p-4 bg-yellow-50 rounded-lg">
                  <h4 className="font-semibold text-gray-800 mb-2">üîã Bajo consumo de bater√≠a</h4>
                  <p className="text-sm text-gray-600">
                    Solo guarda si te moviste m√°s de 50 metros
                  </p>
                </div>
              </div>
            )
          },
          // Pantalla 4: Ubicaciones Manuales
          {
            emoji: '‚úã',
            title: '¬øCu√°ndo a√±adir ubicaci√≥n manual?',
            content: (
              <div className="space-y-3">
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <p className="text-gray-700">
                    ‚úÖ Cuando est√°s <span className="font-semibold">quieto mucho tiempo</span> en un lugar
                  </p>
                  <p className="text-xs text-gray-500 mt-1">(GPS solo guarda si te mueves)</p>
                </div>
                
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <p className="text-gray-700">
                    ‚úÖ Si quieres <span className="font-semibold">asegurar</span> que se registre un lugar espec√≠fico
                  </p>
                </div>
                
                <div className="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                  <p className="text-gray-700">
                    ‚úÖ Si no tienes el <span className="font-semibold">GPS activado</span> en tu dispositivo
                  </p>
                </div>
                
                <div className="mt-4 p-4 bg-gradient-to-r from-blue-500 to-green-500 rounded-lg text-white text-center">
                  <p className="font-semibold">üìç Bot√≥n: "A√±adir ubicaci√≥n"</p>
                  <p className="text-sm opacity-90 mt-1">(Azul-verde en la parte superior)</p>
                </div>
                
                <div className="mt-6 p-4 bg-gradient-to-r from-purple-600 to-pink-500 rounded-lg text-white text-center">
                  <p className="font-bold text-lg">¬°Listo para comenzar! üöÄ</p>
                </div>
              </div>
            )
          }
        ];

        const currentScreen = tutorialContent[tutorialStep];
        const isFirstStep = tutorialStep === 0;
        const isLastStep = tutorialStep === tutorialContent.length - 1;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className={`bg-white rounded-2xl shadow-2xl max-w-2xl w-full ${tutorialStep > 0 ? 'slide-in-right' : 'fade-in'}`}>
              {/* Header */}
              <div className="bg-gradient-to-r from-purple-600 to-pink-500 text-white p-6 rounded-t-2xl">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-5xl">{currentScreen.emoji}</div>
                  <button
                    onClick={() => {
                      setShowTutorial(false);
                      localStorage.setItem('lc_tutorial_seen', 'true');
                    }}
                    className="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
                <h2 className="text-2xl font-bold">{currentScreen.title}</h2>
              </div>

              {/* Content */}
              <div className="p-6">
                {currentScreen.content}
              </div>

              {/* Footer con navegaci√≥n */}
              <div className="p-6 bg-gray-50 rounded-b-2xl flex items-center justify-between">
                <button
                  onClick={() => setTutorialStep(tutorialStep - 1)}
                  disabled={isFirstStep}
                  className={`px-4 py-2 rounded-lg font-medium transition ${
                    isFirstStep
                      ? 'text-gray-400 cursor-not-allowed'
                      : 'text-purple-600 hover:bg-purple-50'
                  }`}
                >
                  ‚Üê Atr√°s
                </button>

                {/* Indicadores de paso */}
                <div className="flex gap-2">
                  {tutorialContent.map((_, index) => (
                    <div
                      key={index}
                      className={`w-2 h-2 rounded-full transition-all ${
                        index === tutorialStep
                          ? 'bg-purple-600 w-6'
                          : 'bg-gray-300'
                      }`}
                    />
                  ))}
                </div>

                <button
                  onClick={() => {
                    if (isLastStep) {
                      setShowTutorial(false);
                      localStorage.setItem('lc_tutorial_seen', 'true');
                      showNotification('¬°Tutorial completado! üéâ');
                    } else {
                      setTutorialStep(tutorialStep + 1);
                    }
                  }}
                  className="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-500 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-pink-600 transition"
                >
                  {isLastStep ? '¬°Empezar!' : 'Siguiente'} ‚Üí
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Crear Alerta
      if (view === 'createAlert') {
        return (
          <div className="min-h-screen bg-gray-50 p-4">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-xl shadow-lg p-6 fade-in border-l-4 border-pink-500">
                <div className="flex items-center gap-3 mb-6">
                  <div className="p-3 bg-gradient-to-br from-pink-500 to-purple-600 rounded-lg">
                    <Bell className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-800">Crear Nueva Alerta</h2>
                    <p className="text-sm text-gray-500">Busca a alguien que viste en un lugar espec√≠fico</p>
                  </div>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üìç Lugar del encuentro
                    </label>
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="ej: Caf√© Central, Plaza Mayor..."
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        value={newAlert.place}
                        onChange={(e) => {
                          const value = e.target.value;
                          setNewAlert({...newAlert, place: value});
                          
                          if (value.length >= 2 && window.PlacesSearch) {
                            const suggestions = window.PlacesSearch.search(value, { limit: 5 });
                            setAlertPlaceSuggestions(suggestions);
                          } else {
                            setAlertPlaceSuggestions([]);
                          }
                        }}
                        onFocus={() => {
                          if (window.PlacesSearch && (!newAlert.place || newAlert.place.length < 2)) {
                            const contextSuggestions = window.PlacesSearch.contextual(5);
                            setAlertPlaceSuggestions(contextSuggestions.slice(0, 8));
                          }
                        }}
                        onBlur={() => {
                          setTimeout(() => setAlertPlaceSuggestions([]), 200);
                        }}
                      />
                      
                      {alertPlaceSuggestions.length > 0 && (
                        <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          {alertPlaceSuggestions.map((suggestion, idx) => (
                            <div
                              key={suggestion.id || idx}
                              className="px-4 py-2 hover:bg-pink-50 cursor-pointer transition"
                              onClick={() => {
                                setNewAlert({
                                  ...newAlert, 
                                  place: suggestion.name
                                });
                                setAlertPlaceSuggestions([]);
                              }}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <div className="font-medium text-gray-800">
                                    {suggestion.name}
                                  </div>
                                  <div className="text-xs text-gray-500">
                                    {suggestion.category}
                                    {suggestion.city && suggestion.city !== 'general' && (
                                      <> ¬∑ {suggestion.city}</>
                                    )}
                                  </div>
                                </div>
                                {suggestion.score && (
                                  <div className="ml-2 text-xs text-pink-600 font-medium">
                                    {Math.round(suggestion.score * 100)}%
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {newAlert.place.length === 0 && (
                        <p className="mt-1 text-xs text-gray-500">
                          üí° Haz clic para ver lugares populares
                        </p>
                      )}
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">üìÖ Fecha</label>
                      <input
                        type="date"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        value={newAlert.date}
                        onChange={(e) => setNewAlert({...newAlert, date: e.target.value})}
                        max={new Date().toISOString().split('T')[0]}
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">‚è∞ Hora</label>
                      <input
                        type="time"
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
                        value={newAlert.time}
                        onChange={(e) => setNewAlert({...newAlert, time: e.target.value})}
                      />
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      üë§ Descripci√≥n de la persona
                    </label>
                    <textarea
                      placeholder="Describe a la persona que quieres encontrar..."
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 h-32 resize-none"
                      value={newAlert.description}
                      onChange={(e) => setNewAlert({...newAlert, description: e.target.value})}
                    />
                  </div>
                  
                  <div className="flex gap-3 mt-6">
                    <button
                      onClick={() => setView('feed')}
                      className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
                    >
                      Cancelar
                    </button>
                    <button
                      onClick={createAlert}
                      disabled={!newAlert.place || !newAlert.date || !newAlert.time || !newAlert.description}
                      className="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition font-semibold disabled:opacity-50"
                    >
                      Publicar Alerta
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Chat
      if (view === 'chat' && activeChat) {
        return (
          <div className="min-h-screen bg-gray-50 flex flex-col">
            <div className="bg-white border-b px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={closeChat} className="text-gray-600 hover:text-gray-800 font-medium">
                  ‚Üê Volver
                </button>
                <div>
                  <h3 className="font-semibold text-gray-800">Chat an√≥nimo</h3>
                  <p className="text-sm text-gray-500">{activeChat.place_name}</p>
                </div>
              </div>
              <button
                onClick={revealIdentity}
                className="flex items-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm hover:bg-purple-200 transition"
              >
                <Eye className="w-4 h-4" />
                Revelarme
              </button>
            </div>
            
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
              {chatMessages.length === 0 ? (
                <div className="text-center text-gray-500 mt-8">
                  <MessageCircle className="w-12 h-12 mx-auto mb-3 opacity-50" />
                  <p>No hay mensajes a√∫n</p>
                  <p className="text-sm">¬°Inicia la conversaci√≥n!</p>
                </div>
              ) : (
                chatMessages.map(msg => (
                  <div 
                    key={msg.id} 
                    className={`flex ${msg.sender_id === user.id ? 'justify-end' : 'justify-start'} fade-in`}
                  >
                    <div className={`max-w-xs px-4 py-2 rounded-lg ${
                      msg.sender_id === user.id 
                        ? 'bg-purple-600 text-white' 
                        : 'bg-white border border-gray-200 text-gray-800'
                    }`}>
                      <p className={`text-xs mb-1 ${
                        msg.sender_id === user.id ? 'text-purple-200' : 'text-gray-500'
                      }`}>
                        {msg.is_revealed ? msg.sender_nickname : 'An√≥nimo'}
                      </p>
                      <p>{msg.content}</p>
                    </div>
                  </div>
                ))
              )}
              
              {otherUserTyping && (
                <div className="flex justify-start">
                  <div className="bg-gray-100 px-4 py-3 rounded-lg">
                    <div className="typing-indicator">
                      <span></span>
                      <span></span>
                      <span></span>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <div className="bg-white border-t p-4">
              <div className="flex gap-2">
                <input
                  type="text"
                  placeholder="Escribe un mensaje..."
                  className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                  value={newMessage}
                  onChange={handleTyping}
                  onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                />
                <button
                  onClick={sendMessage}
                  disabled={!newMessage.trim()}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition disabled:opacity-50"
                >
                  <Send className="w-5 h-5" />
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Feed principal
      return (
        <div className="min-h-screen bg-gray-50">
          {/* Notificaci√≥n normal */}
          {notification && (
            <div className={`fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 fade-in ${
              notification.type === 'success' ? 'bg-green-500 text-white' :
              notification.type === 'error' ? 'bg-red-500 text-white' :
              'bg-blue-500 text-white'
            }`}>
              {notification.message}
            </div>
          )}

          {/* Notificaci√≥n en tiempo real - Popup interactivo */}
          {realtimeNotification && (
            <div 
              className={`fixed top-4 right-4 max-w-sm w-full bg-white rounded-lg shadow-2xl z-50 fade-in cursor-pointer hover:shadow-xl transition-all ${
                realtimeNotification.type === 'alert' ? 'border-l-4 border-pink-500' :
                'border-l-4 border-purple-500'
              }`}
              onClick={() => {
                if (realtimeNotification.type === 'match' && realtimeNotification.data) {
                  openChat(realtimeNotification.data.id);
                } else if (realtimeNotification.type === 'alert') {
                  setUnreadAlertsCount(0);
                  window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                setRealtimeNotification(null);
              }}
            >
              <div className="p-4">
                <div className="flex items-start gap-3">
                  <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${
                    realtimeNotification.type === 'alert' 
                      ? 'bg-gradient-to-br from-pink-500 to-purple-600' 
                      : 'bg-gradient-to-br from-purple-500 to-pink-500'
                  }`}>
                    {realtimeNotification.type === 'alert' ? (
                      <Bell className="w-6 h-6 text-white" />
                    ) : (
                      <MessageCircle className="w-6 h-6 text-white" />
                    )}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-semibold text-gray-900 mb-1">
                      {realtimeNotification.title}
                    </p>
                    <p className="text-sm text-gray-600">
                      {realtimeNotification.message}
                    </p>
                    <p className="text-xs text-gray-400 mt-2">
                      Click para ver ‚Üí
                    </p>
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setRealtimeNotification(null);
                    }}
                    className="flex-shrink-0 text-gray-400 hover:text-gray-600"
                  >
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Header */}
          <div className="bg-white shadow-sm border-b">
            <div className="max-w-4xl mx-auto px-4 py-4">
              <div className="flex justify-between items-center mb-3">
                <div>
                  <h1 className="text-2xl font-bold text-gray-800">Siiy√∫</h1>
                  <p className="text-sm text-gray-600">{user?.nickname}</p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => {
                      setShowTutorial(true);
                      setTutorialStep(0);
                    }}
                    className="p-2 text-purple-600 bg-purple-50 hover:bg-purple-100 rounded-lg transition"
                    title="Ver tutorial"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </button>
                  <button
                    onClick={handleLogout}
                    className="p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition"
                    title="Cerrar sesi√≥n"
                  >
                    <LogOut className="w-5 h-5" />
                  </button>
                  <button
                    onClick={() => setView('createAlert')}
                    className="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition font-semibold flex items-center gap-2"
                  >
                    <Bell className="w-5 h-5" />
                    Nueva Alerta
                  </button>
                </div>
              </div>
              
              <div className="flex items-center gap-2 text-sm flex-wrap">
                <div className="flex items-center gap-1">
                  {geo.tracking ? (
                    <>
                      <Navigation className="w-4 h-4 text-green-600 pulse" />
                      <span className="text-green-600 font-medium">GPS activo</span>
                      {geo.queuedLocations > 0 && (
                        <span className="text-xs text-gray-500">({geo.queuedLocations} pendientes)</span>
                      )}
                    </>
                  ) : (
                    <>
                      <Navigation className="w-4 h-4 text-gray-400" />
                      <span className="text-gray-500">GPS inactivo</span>
                    </>
                  )}
                </div>
                <span className="text-gray-300">‚Ä¢</span>
                <span className="text-gray-600">{locations.length} ubicaciones</span>
                <span className="text-gray-300">‚Ä¢</span>
                <span className="text-gray-600">{alerts.length} alertas</span>
                <span className="text-gray-300">‚Ä¢</span>
                <span className="text-gray-600">{matches.length} matches</span>
                <button
                  onClick={() => setShowAddLocation(true)}
                  className="ml-auto flex items-center gap-1 px-3 py-1.5 bg-gradient-to-r from-blue-500 to-green-500 text-white rounded-lg text-sm hover:from-blue-600 hover:to-green-600 transition font-medium"
                >
                  <MapPin className="w-4 h-4" />
                  Registrar ubicaci√≥n (sin GPS)
                </button>
              </div>

              {geo.error && (
                <div className="mt-2 px-3 py-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <p className="text-xs text-yellow-800">
                    ‚ö†Ô∏è GPS: {geo.error}. Puedes a√±adir ubicaciones manualmente.
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* Modal: A√±adir ubicaci√≥n */}
          {showAddLocation && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-xl p-6 max-w-md w-full fade-in border-l-4 border-blue-500 max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-gradient-to-br from-blue-500 to-green-500 rounded-lg">
                      <MapPin className="w-5 h-5 text-white" />
                    </div>
                    <div>
                      <h3 className="text-xl font-bold text-gray-800">Registrar ubicaci√≥n</h3>
                      <p className="text-xs text-gray-500">Sin necesidad de GPS activo</p>
                    </div>
                  </div>
                  <button onClick={() => {
                    setShowAddLocation(false);
                    setPlaceSuggestions([]);
                  }}>
                    <X className="w-5 h-5 text-gray-500 hover:text-gray-700" />
                  </button>
                </div>
                
                {/* Ubicaciones GPS recientes */}
                {locations.filter(loc => loc.is_automatic).length > 0 && (
                  <div className="mb-6">
                    <h4 className="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                      <Navigation className="w-4 h-4 text-green-600" />
                      Tus ubicaciones GPS recientes
                    </h4>
                    <div className="space-y-2 max-h-48 overflow-y-auto">
                      {locations.filter(loc => loc.is_automatic).slice(0, 10).map(loc => (
                        <button
                          key={loc.id}
                          onClick={() => {
                            const date = new Date(loc.timestamp);
                            setManualLocation({
                              place: loc.place_name,
                              date: date.toISOString().split('T')[0],
                              time: date.toTimeString().slice(0, 5)
                            });
                          }}
                          className="w-full text-left px-3 py-2 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition"
                        >
                          <div className="font-medium text-gray-800 text-sm">{loc.place_name}</div>
                          <div className="text-xs text-gray-600 mt-0.5">
                            üìÖ {new Date(loc.timestamp).toLocaleDateString('es-ES')} ¬∑ 
                            ‚è∞ {new Date(loc.timestamp).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                          </div>
                        </button>
                      ))}
                    </div>
                    <div className="mt-3 pt-3 border-t border-gray-200">
                      <p className="text-xs text-gray-500 text-center">
                        üëÜ Click en una ubicaci√≥n para seleccionarla
                      </p>
                    </div>
                  </div>
                )}
                
                <div className="space-y-4">
                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      O escribe manualmente:
                    </label>
                    <input
                      type="text"
                      placeholder="Lugar (ej: Caf√© Central, Starbucks...)"
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      value={manualLocation.place}
                      onChange={(e) => {
                        const value = e.target.value;
                        setManualLocation({...manualLocation, place: value});
                        
                        if (value.length >= 2 && window.PlacesSearch) {
                          const suggestions = window.PlacesSearch.search(value, { limit: 5 });
                          setPlaceSuggestions(suggestions);
                        } else {
                          setPlaceSuggestions([]);
                        }
                      }}
                      onFocus={() => {
                        if (window.PlacesSearch && (!manualLocation.place || manualLocation.place.length < 2)) {
                          const contextSuggestions = window.PlacesSearch.contextual(8); 
                          setPlaceSuggestions(contextSuggestions.slice(0, 8));
                        }
                      }}
                      onBlur={() => {
                        setTimeout(() => setPlaceSuggestions([]), 200);
                      }}
                    />
                    
                    {placeSuggestions.length > 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {placeSuggestions.map((suggestion, idx) => (
                          <div
                            key={suggestion.id || idx}
                            className="px-4 py-2 hover:bg-blue-50 cursor-pointer transition"
                            onClick={() => {
                              setManualLocation({
                                ...manualLocation, 
                                place: suggestion.name
                              });
                              setPlaceSuggestions([]);
                            }}
                          >
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="font-medium text-gray-800">
                                  {suggestion.name}
                                </div>
                                <div className="text-xs text-gray-500">
                                  {suggestion.category}
                                  {suggestion.city && suggestion.city !== 'general' && (
                                    <> ¬∑ {suggestion.city}</>
                                  )}
                                </div>
                              </div>
                              {suggestion.score && (
                                <div className="ml-2 text-xs text-blue-600 font-medium">
                                  {Math.round(suggestion.score * 100)}%
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {manualLocation.place.length === 0 && (
                      <p className="mt-1 text-xs text-gray-500">
                        üí° Haz clic para ver lugares populares
                      </p>
                    )}
                  </div>

                  <input
                    type="date"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    value={manualLocation.date}
                    onChange={(e) => setManualLocation({...manualLocation, date: e.target.value})}
                    max={new Date().toISOString().split('T')[0]}
                  />

                  <input
                    type="time"
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    value={manualLocation.time}
                    onChange={(e) => setManualLocation({...manualLocation, time: e.target.value})}
                  />

                  <button
                    onClick={addManualLocation}
                    disabled={!manualLocation.place || !manualLocation.date || !manualLocation.time}
                    className="w-full px-4 py-2 bg-gradient-to-r from-blue-500 to-green-500 text-white rounded-lg hover:from-blue-600 hover:to-green-600 transition font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Guardar Ubicaci√≥n
                  </button>
                </div>

                {locations.length > 0 && (
                  <div className="mt-6 pt-4 border-t">
                    <h4 className="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                      <MapPin className="w-4 h-4 text-blue-600" />
                      Ubicaciones recientes:
                    </h4>
                    <div className="space-y-2 max-h-40 overflow-y-auto">
                      {locations.slice(0, 5).map(loc => (
                        <div key={loc.id} className="flex items-center justify-between text-sm bg-gradient-to-r from-blue-50 to-green-50 px-3 py-2 rounded border-l-2 border-blue-400">
                          <div className="flex-1">
                            <span className="font-medium">{loc.place_name}</span>
                            <span className="text-gray-500 ml-2 text-xs">
                              {new Date(loc.timestamp).toLocaleDateString()}
                            </span>
                            {loc.is_automatic && (
                              <span className="ml-2 text-xs badge-ubicacion text-white px-2 py-0.5 rounded font-medium">
                                GPS
                              </span>
                            )}
                          </div>
                          {!loc.is_automatic && (
                            <button
                              onClick={() => removeLocation(loc.id)}
                              className="text-red-500 hover:text-red-700 ml-2"
                              title="Eliminar"
                            >
                              <Trash className="w-4 h-4" />
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Contenido principal */}
          <div className="max-w-4xl mx-auto p-4">
            {/* Matches */}
            {matches.length > 0 && (
              <div className="mb-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                  <MessageCircle className="w-5 h-5 text-purple-600" />
                  Tus Matches ({matches.length})
                </h2>
                <div className="grid gap-3">
                  {matches.map(match => (
                    <div
                      key={match.id}
                      className={`bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-4 text-white cursor-pointer hover:shadow-lg transition fade-in ${
                        match.hasUnread ? 'ring-2 ring-yellow-400' : ''
                      }`}
                      onClick={() => openChat(match.id)}
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="font-semibold">
                            {match.hasUnread && 'üîî '}Match con {match.other_user_nickname || 'An√≥nimo'}
                          </p>
                          <p className="text-sm opacity-90">{match.place_name}</p>
                          {match.last_message && (
                            <p className="text-xs opacity-75 mt-1 truncate">
                              {match.last_message}
                            </p>
                          )}
                        </div>
                        <MessageCircle className="w-6 h-6" />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Alertas */}
            <div className="mb-4">
              <h2 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                <Bell className="w-5 h-5 text-pink-600" />
                Alertas para ti ({alerts.length})
                {unreadAlertsCount > 0 && (
                  <span className="flex items-center justify-center w-6 h-6 bg-pink-500 text-white text-xs font-bold rounded-full pulse">
                    {unreadAlertsCount}
                  </span>
                )}
              </h2>
              <p className="text-xs text-gray-500 ml-7">
                üì£ Personas buscando a alguien en lugares donde estuviste
              </p>
            </div>
            
            {alerts.length === 0 ? (
              <div className="bg-white rounded-lg shadow p-8 text-center">
                <Bell className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                <p className="text-gray-600 mb-2">No hay alertas para ti</p>
                <p className="text-sm text-gray-500 mb-4">
                  {locations.length === 0 
                    ? geo.tracking 
                      ? 'El GPS est√° registrando tus ubicaciones...'
                      : 'A√±ade ubicaciones para ver alertas relevantes'
                    : 'Cuando alguien publique una alerta en tus lugares, aparecer√° aqu√≠'
                  }
                </p>
                {!geo.tracking && locations.length === 0 && (
                  <button
                    onClick={() => setShowAddLocation(true)}
                    className="px-4 py-2 bg-gradient-to-r from-blue-500 to-green-500 text-white rounded-lg hover:from-blue-600 hover:to-green-600 transition"
                  >
                    A√±adir ubicaci√≥n
                  </button>
                )}
              </div>
            ) : (
              <div 
                className="space-y-4"
                onClick={() => setUnreadAlertsCount(0)}
              >
                {alerts.map(alert => (
                  <div key={alert.id} className="bg-white rounded-lg shadow p-5 fade-in border-l-4 border-pink-500 hover:shadow-md transition">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <span className="badge-alerta text-white px-2.5 py-1 rounded-full text-xs font-semibold">
                          ALERTA
                        </span>
                        <div className="flex items-center gap-2 text-pink-600">
                          <MapPin className="w-5 h-5" />
                          <span className="font-semibold">{alert.place_name}</span>
                        </div>
                      </div>
                      {alert.is_own_alert && (
                        <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-medium">
                          Tu alerta
                        </span>
                      )}
                    </div>
                    
                    <div className="flex items-center gap-4 text-sm text-gray-600 mb-3">
                      <span className="flex items-center gap-1">
                        <Clock className="w-4 h-4" />
                        {alert.date} a las {alert.time}
                      </span>
                    </div>
                    
                    <p className="text-gray-700 mb-4">{alert.description}</p>
                    
                    <div className="flex items-center justify-between">
                      <span className="text-xs text-gray-500">
                        Por: {alert.author}
                      </span>
                      
                      {!alert.is_own_alert && !alert.has_responded && (
                        <button
                          onClick={() => respondToAlert(alert.id)}
                          className="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:from-pink-600 hover:to-purple-700 transition text-sm font-semibold"
                        >
                          ¬°Soy yo! Responder
                        </button>
                      )}
                      
                      {alert.has_responded && (
                        <span className="text-sm text-green-600 font-semibold">
                          ‚úì Ya respondiste
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    // Renderizar
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
